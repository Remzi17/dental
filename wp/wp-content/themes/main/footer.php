</main> 

<footer class="footer">
	<div class="footer__top-wrapper">
		<div class="container">
			<div class="footer__top">
				<div class="col footer__left">
					<a href="<?=is_front_page() ? '#home' : '/' ?>" class="logo footer__logo">
						<img src="<?=get_template_directory_uri()?>/assets/img/logo.svg" width="40" height="40" alt="">
						<div class="logo__title">
							<p>Dental</p>
							<p>City</p>
						</div>
					</a>
					<div class="footer__text">
						<p>–û–û–û Dental City</p>
						<p>
							–û–ì–†–ù: 00000000000000 <br>
							–ò–ù–ù: 0000000000 <br> 
							–ö–ü–ü: 0000000000
						</p>
					</div>
				</div>
				<div class="footer__item footer__item-menu">
					<div class="title-3 footer__item-title">–ú–µ–Ω—é</div>
					<ul class="menu footer__menu">
						<li class="menu-item-has-children current-menu-item">
							<a href="about.html">
								–û –Ω–∞—Å
								<span class="menu-item-arrow"></span>
							</a>
							<div class="sub-menu-wrapper">
								<ul class="sub-menu">
									<li><a href="license.html">–õ–∏—Ü–µ–Ω–∑–∏–∏</a></li>
									<li><a href="feedback.html">–û—Ç–∑—ã–≤—ã</a></li>
									<li><a href="vacancy.html">–í–∞–∫–∞–Ω—Å–∏–∏</a></li>
								</ul>
							</div>
						</li>
						<li><a href="feedback.html">–û—Ç–∑—ã–≤—ã</a></li>
						<li class="menu-item-has-children">
							<a href="category.html">
								–ü—Ä–æ–¥—É–∫—Ç—ã
								<span class="menu-item-arrow"></span>
							</a>
							<div class="sub-menu-wrapper">
								<ul class="sub-menu">
									<li><a href="category-2.html">RuMap-GIS</a></li>
									<li><a href="category-2.html">RuMap –°–µ—Ä–≤–∏—Å—ã</a></li>
									<li><a href="category-2.html">–ì–µ–æ–ø–æ—Ä—Ç–∞–ª RuMap</a></li>
									<li><a href="category-2.html">RuMap –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</a></li>
									<li><a href="category-2.html">–ì–µ–æ–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</a></li>
								</ul>
							</div>
						</li>
						<li><a href="news.html">–ù–æ–≤–æ—Å—Ç–∏</a></li>
						<li class="menu-item-has-children">
							<a href="category-2.html">
								–£—Å–ª—É–≥–∏
								<span class="menu-item-arrow"></span>
							</a>
							<div class="sub-menu-wrapper">
								<ul class="sub-menu">
									<li><a href="category-2.html">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è</a></li>
									<li><a href="category-2.html">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a></li>
									<li><a href="category-2.html">–ì–µ–æ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</a></li>
									<li><a href="category-2.html">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</a></li>
									<li><a href="category-2.html">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è</a></li>
									<li><a href="category-2.html">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a></li>
									<li><a href="category-2.html">–ì–µ–æ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</a></li>
									<li><a href="category-2.html">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</a></li>
								</ul>
							</div>
						</li>
						<li><a href="contact.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
						<li><a href="project.html">–ü—Ä–æ–µ–∫—Ç—ã</a></li>
					</ul>
				</div>
				<div class="footer__item footer__item-contacts">
					<div class="title-3 footer__item-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</div>

					<div class="footer__contacts">
						<div class="call contact__call">
							<a href="tel:+79876543210" class="hover-active tel contact__item">
								<svg class="phone-icon">
									<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#phone"></use>
								</svg>
								<span>+7 (987) 654-32-10</span>
							</a>
							<div class="social contact__social">
								<a href="https://wa.me/+79876543210" class="social__item" target="_blank">
									<svg class="whatsapp-icon">
										<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#whatsapp"></use>
									</svg>
								</a>
								<a href="https://t.me/+79876543210" class="social__item" target="_blank">
									<svg class="telegram-icon">
										<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#telegram"></use>
									</svg>
								</a>
							</div>
						</div>

						<a href="mailto:info@admin.ru" class="hover-active email footer__email">
							<div class="icon">
								<svg class="email-icon">
									<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#email"></use>
								</svg>
							</div>
							<span>info@admin.ru</span>
						</a>
						<div class="address">
							<div class="icon">
								<svg class="location-icon">
									<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#location"></use>
								</svg>
							</div>
							<span>–≥. –ú–æ—Å–∫–≤–∞, —É–ª –ü–µ—Ç—Ä–æ–≤–∞, –¥–æ–º 9–∞, –æ—Ñ–∏—Å 125</span>
						</div>
						<div class="time">
							<div class="icon">
								<svg class="time-icon">
									<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>#time"></use>
								</svg>
							</div>
							<span>–ü–Ω-–ü—Ç, —Å¬†9:00¬†–¥–æ¬†18:00</span>
						</div>
						<div class="footer__buttons">
							<button class="button button_border button_white" type="button" data-modal="popup-call">–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="footer__bottom-wrapper">
		<div class="container">
			<div class="footer__bottom">
				<span>Copyright ¬©2025 Dental City</span>
				<a href="sitemap.html" class="hover-active" target="_blank">–ö–∞—Ä—Ç–∞ —Å–∞–π—Ç–∞</a>
				<a href="text.html" class="hover-active" target="_blank">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
				<a href="text.html" class="hover-active" target="_blank">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
			</div>
		</div>
	</div>
</footer>  


</div>

<div class="popups">
	<!-- –ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫ -->
	<div class="popup popup-call" id="popup-call">
		<div class="popup__dialog">
			<div class="popup__content">
				<button class="popup__close" type="button" data-popup-close>
					<svg class="close">
						<use xlink:href="assets/img/sprite.svg#close"></use>
					</svg>
				</button>
				<div class="form popup__form">
					<div class="title-2 popup__title">–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</div>
					<form>
						<input type="hidden" name="info" class="popup-info">
						<div class="form__fields form__fields-col">
							<input class="input" type="text" name="name" placeholder="–ò–º—è" required>
							<input class="input" type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
							<label class="small-text checkbox">
								<input class="checkbox__input" type="checkbox" checked required>
								<span class="checkbox__text">–ù–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Äú–û—Ç–ø—Ä–∞–≤–∏—Ç—å‚Äù, –í—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="text.html" class="underline" target="_blank">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></span>
							</label>
							<button class="button submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ -->
	<div class="popup popup-feedback" id="popup-feedback">
		<div class="popup__dialog">
			<div class="popup__content">
				<button class="popup__close" type="button" data-popup-close>
					<svg class="close">
						<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg#close"></use>
					</svg>
				</button>
				<div class="form popup__form">
					<div class="title-2 popup__title">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</div>
					<form>
						<input type="hidden" name="info" class="popup-info">
						<div class="form__fields" style="--columns: 2">
							<input class="input" type="text" name="name" placeholder="–í–∞—à–µ –∏–º—è*" required>
							<input class="input" type="tel" name="phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω*" required>

							<?
								$fields = [
									"clinic" => '–§–∏–ª–∏–∞–ª—ã',
									"services" => '–£—Å–ª—É–≥–∏',
									"doctor" => '–í—Ä–∞—á',
								];

								foreach ($fields as $label => $title) {
									$posts = get_posts([
										'post_type' => $label,
										'posts_per_page' => -1,
										'fields' => 'ids'
									]); 
										
									?>
										<select name="<?=$label ?>">
											<option data-placeholder="true"><?=$title ?></option>
											<?
												foreach($posts as $id) {
													?>
														<option value="<?=$id?>"><?=get_the_title($id)?></option>
													<?
												}
											?>
										</select>
									<?
								}
							?>
							<div class="input">
								<span>–†–µ–π—Ç–∏–Ω–≥*</span>
								<div class="rating">
									<div class="rating__item rating__item_set">
										<div class="rating__body">
											<div class="rating__active"></div>
											<div class="rating__items">
												<input type="radio" value="1" name="rating" required>
												<input type="radio" value="2" name="rating" required>
												<input type="radio" value="3" name="rating" required>
												<input type="radio" value="4" name="rating" required>
												<input type="radio" value="5" name="rating" required>
											</div>
										</div>
										<div class="rating__value">0</div>
									</div>
								</div>
							</div>
							<textarea class="textarea" name="message" cols="30" rows="5" placeholder="–í–∞—à –æ—Ç–∑—ã–≤*" required data-columns="full"></textarea>
							<label class="small-text checkbox" data-columns="full">
								<input class="checkbox__input" type="checkbox" checked required>
								<span class="checkbox__text">–ù–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Äú–û—Ç–ø—Ä–∞–≤–∏—Ç—å‚Äù, –í—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="/policy" class="underline" target="_blank">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></span>
							</label>
							<button class="button submit justify-center" data-columns="full">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- –ü–æ–ª–Ω—ã–π –æ—Ç–∑—ã–≤ -->
	<div class="popup popup-reviews" id="popup-reviews">
		<div class="popup__dialog">
			<div class="popup__content">
				<button class="popup__close" type="button" data-popup-close>
					<svg class="close">
						<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg#close"></use>
					</svg>
				</button>
				<div class="popup-reviews__wrapper"></div>
			</div>
		</div>
	</div>

	<!-- –û–∫–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ -->
	<div class="popup popup-thank" id="popup-thank">
		<div class="popup__dialog" role="document">
			<div class="popup__content">
				<button class="popup__close" data-popup-close>
					<svg class='close'>
						<use xlink:href="<?=get_template_directory_uri()?>/assets/img/sprite.svg?ver=<?=spriteVersion()?>ver=<?=spriteVersion()?>#close"></use>
					</svg>
				</button>
				<div class="popup__title">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
				<img src="<?=get_template_directory_uri()?>/assets/img/icons/check.svg" width="60" alt="">
			</div>
		</div>
	</div>
</div> 
 
<?
	wp_footer(); 
?>   
  
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const notify = (title='', text='', type='info', autohide = true, interval = 2500) => {
			console.log(`üîπ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${title} ${text} [${type}]`) // üîπ –õ–û–ì
			new Notify({ title, text, theme:type, autohide, interval })
		}

		const escapeHTML = s => {
			if (!s && s !== 0) return ''
			return String(s)
				.replace(/&/g,'&amp;')
				.replace(/</g,'&lt;')
				.replace(/>/g,'&gt;')
				.replace(/"/g,'&quot;')
				.replace(/'/g,'&#039;') 
		}

		const currentUser = {
			id: <?=get_current_user_id()?>,
			name: <?=json_encode(is_user_logged_in() ? wp_get_current_user()->display_name : '')?>,
			email: <?=json_encode(is_user_logged_in() ? wp_get_current_user()->user_email : '')?>
		}

		const guestData = JSON.parse(localStorage.getItem('comment_guest') || '{}')
		console.log('üîπ –î–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è –∏–∑ localStorage:', guestData) // üîπ –õ–û–ì


		console.log('üîπ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser) // üîπ –õ–û–ì

		function createCommentElement({ id, author, text, avatar, date = '—Ç–æ–ª—å–∫–æ —á—Ç–æ', likes = 0, dislikes = 0, can_delete = true, show_reply = true }) {

			console.log(`üîπ –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è id: ${id}, –∞–≤—Ç–æ—Ä: ${author}, can_delete: ${can_delete}, show_reply: ${show_reply}`) // üîπ –õ–û–ì
			const tpl = document.querySelector('#comment-template')
			if (!tpl) return null

			const el = tpl.content.firstElementChild.cloneNode(true)
    
			el.id = `comment-${id}`
			el.querySelector('[data-author]').textContent = author
			el.querySelector('[data-text]').innerHTML = `<p>${text}</p>`
    
			const avatarEl = el.querySelector('[data-avatar]')
			if(avatarEl) avatarEl.src = avatar
			const dateEl = el.querySelector('[data-date]')
			if(dateEl) dateEl.textContent = date

			const commentData = window.commentsData.find(c => c.id === id)

			const is_own_like = commentData ? commentData.is_own_like : false
			const is_own_dislike = commentData ? commentData.is_own_dislike : false
			const likeBtn = el.querySelector('[data-like]')
			const dislikeBtn = el.querySelector('[data-dislike]')
			const deleteBtn = el.querySelector('[data-delete]')
			const replyBtn = el.querySelector('[data-reply]')

			if (likeBtn) { 
				likeBtn.dataset.commentId = id
				likeBtn.querySelector('span').textContent = likes
				// –°—Ç–∞–≤–∏–º active —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å—Ç–∞–≤–∏–ª –ª–∞–π–∫
				if (is_own_like) likeBtn.classList.add('active')
				else likeBtn.classList.remove('active')
			}

			if (dislikeBtn) { 
				dislikeBtn.dataset.commentId = id
				dislikeBtn.querySelector('span').textContent = dislikes
				// –°—Ç–∞–≤–∏–º active —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å—Ç–∞–≤–∏–ª –¥–∏–∑–ª–∞–π–∫
				if (is_own_dislike) dislikeBtn.classList.add('active')
				else dislikeBtn.classList.remove('active')
			}

			if (deleteBtn) {
				deleteBtn.dataset.commentId = id

				// –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤: —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –∞–¥–º–∏–Ω/—Ä–µ–¥–∞–∫—Ç–æ—Ä
				const isOwnComment = can_delete  // —Ç–≤–æ—è —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è "—Å–≤–æ–π"
				const isEditorOrHigher = window.currentUser && ['administrator', 'editor'].includes(window.currentUser.role)

				if (!isOwnComment && !isEditorOrHigher) {
					deleteBtn.remove()
					console.log(`üîπ –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è id: ${id} (–Ω–µ—Ç –ø—Ä–∞–≤)`)
				} else {
					console.log(`üîπ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è id: ${id}`)
				}
			}

			if (replyBtn && (!show_reply || can_delete === false && author === '')) {
				replyBtn.remove()
				console.log(`üîπ Reply —É–±—Ä–∞–Ω –¥–ª—è id:${id}`)
			}

			return el
		}


		const updateCommentsUI = () => {
			const wrapper = document.querySelector('.comments__wrapper')
			const countEl = document.querySelector('.title-2 .gray-text')
			if (countEl){
				countEl.textContent = ' ' + (wrapper?.querySelectorAll('.comment').length || 0)
				console.log(`üîπ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${countEl.textContent.trim()}`) // üîπ –õ–û–ì
			}
		}
 
		const initForm = form => {
			if (!form || form.dataset.formInitialized) return
			form.dataset.formInitialized = '1'

			const authorInput = form.querySelector('[name="author"]')
			const emailInput = form.querySelector('[name="email"]')

			if(currentUser.id) {
				if (authorInput) authorInput.value = currentUser.name
				if (emailInput) emailInput.value = currentUser.email
			} else {
				if (authorInput && guestData.name) authorInput.value = guestData.name
				if (emailInput && guestData.email) emailInput.value = guestData.email
			}

			const btn = form.querySelector('button[type="submit"]')
			if (!btn) return

			form.addEventListener('keydown', event => {
				if (
					event.key === 'Enter' &&
					(event.ctrlKey || event.metaKey)
				) {
					event.preventDefault()

					if (form.checkValidity()) {
						form.requestSubmit()
					}
				}
			})

			form.addEventListener('submit', async e => {
				e.preventDefault()
				btn.disabled = true
				const originalBtnText = btn.textContent
				btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...'

				try {
					const formData = new FormData(form)
					formData.append('action', 'add_comment')

					console.log('üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', Object.fromEntries(formData.entries())) // üîπ –õ–û–ì

					const res = await fetch('<?=admin_url("admin-ajax.php")?>', {
						method: 'POST',
						credentials: 'same-origin',
						body: formData
					})

					if (!res.ok) throw new Error('Bad response')

					const data = await res.json().catch(() => null)
					console.log('üîπ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data) // üîπ –õ–û–ì

					const authorName = authorInput.value
					const parentId = form.querySelector('[name="comment_parent"]')?.value || 0
					const wrapper = document.querySelector('.comments__wrapper')
					const commentText = form.querySelector('[name="comment"]');
  
					// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ DOM —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –æ–¥–æ–±—Ä–µ–Ω
					if (data?.data?.approved) {
						console.log('üîπ –°–æ–∑–¥–∞–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è id:' + data.data.comment_id, 'isOwnComment:true')

						const isEditorOrHigher = window.currentUser && ['administrator', 'editor'].includes(window.currentUser.role)

						const newCommentEl = createCommentElement({
							id: data.data.comment_id,
							author: authorName,
							text: commentText?.value || '',
							avatar: currentUser.id 
								? `<?=get_field('–∞–≤–∞—Ç–∞—Ä', 'user_' . get_current_user_id())['sizes']['thumbnail']?>`
								: '<?=get_avatar_url("", ["size"=>64])?>',
							likes: 0,
							dislikes: 0,
							can_delete: true,
							show_reply: isEditorOrHigher, 
							parentId
						})

						newCommentEl.classList.add('bounceOutTop')

						if (parentId && parentId != '0') {
							const parent = document.querySelector(`#comment-${parentId}`)

							if (parent){
								parent.querySelector('.comment__content').appendChild(newCommentEl)
							} else {
								wrapper.prepend(newCommentEl)
							}
						} else {
							wrapper.prepend(newCommentEl)
						}

						setTimeout(() => {
							newCommentEl.classList.remove('bounceOutTop')
						}, 500);
					}

					form.reset();

					if (!currentUser.id) {
						const newGuest = {
							name: authorName,
							email: formData.get('email') || ''
						}

						localStorage.setItem('comment_guest', JSON.stringify(newGuest))

						const authorField = form.querySelector('[name="author"]')
						const emailField = form.querySelector('[name="email"]')

						if (authorField) authorField.value = newGuest.name
						if (emailField) emailField.value = newGuest.email
					}

					initReply()
					updateCommentsUI()
					notify(data?.data?.approved ? '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω' : '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é', '', 'success')

				} catch (err) {
					console.error('üîπ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err) // üîπ –õ–û–ì
					notify('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', '', 'danger')
				} finally {
					btn.disabled = false
					btn.textContent = originalBtnText;
					document.querySelectorAll('.comment-add').forEach(commentForm => {
						if (!commentForm.closest('.comments__top')) {
							commentForm.remove()
						}
						
					})
				}
			})
		}

		document.querySelectorAll('.comment-add').forEach(initForm)

		// ===============================
		// –û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
		// ===============================
		const initReply = () => {
			document.querySelectorAll('.comment__reply').forEach(btn => {
				if(btn.dataset.replyInitialized) return
				btn.dataset.replyInitialized = '1'

				btn.addEventListener('click', e => {
					const comment = btn.closest('.comment')
					if(!comment) return
					console.log(`üîπ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π id:${comment.id}`)

					// –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ä–º–∞ –ø–æ–¥ —ç—Ç–∏–º –∫–æ–º–º–µ–Ω—Ç–æ–º ‚Äî —É–¥–∞–ª—è–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º
					const existingForm = comment.querySelector('.comment-add')
					if (existingForm) {
						existingForm.remove()
						return
					}

					// –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º—ã –∫—Ä–æ–º–µ –æ—Å–Ω–æ–≤–Ω–æ–π
					document.querySelectorAll('.comment-add').forEach(form => {
						if(form.dataset.formInitialized === '1' && form !== document.querySelector('.comment-add[data-main]') && !form.closest('.comments__top')) {
							form.remove()
						}
					})

					const commentId = comment.id.replace('comment-','')
					const postId = document.querySelector('#comment_post_ID')?.value || ''
					const hasAuthor = localStorage.getItem('comment_guest')
					const showFields = !currentUser.id && !hasAuthor

					const html = `
						<form class="form comment-add">
							<input type="hidden" name="comment_post_ID" value="${escapeHTML(postId)}">
							<input type="hidden" name="comment_parent" value="${escapeHTML(commentId)}">
							<div class="form__fields" style="--columns: 2">
								<input class="input" type="text" name="author" placeholder="–í–∞—à–µ –∏–º—è" required>
								<input class="input" type="email" name="email" placeholder="–í–∞—à email" required>
								<textarea name="comment" class="textarea" placeholder="–û—Ç–≤–µ—Ç" required data-columns="full"></textarea>
							</div>
							<div class="flex justify-start">
								<button class="button button_small" type="submit">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
							</div>
						</form>
					`
					comment.querySelector('.comment__meta').insertAdjacentHTML('afterend', html)
					initForm(comment.querySelector('form.comment-add'))
					comment.querySelector('form.comment-add textarea')?.focus()
				})
			})
		}

		initReply()

		// ===============================
		// –†–µ–Ω–¥–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
		// ===============================
		if (Array.isArray(window.commentsData) && window.commentsData.length) {
			const wrapper = document.querySelector('.comments__wrapper')
			wrapper.innerHTML = ''

			const commentsMap = new Map()

			// 1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ Map
			window.commentsData.forEach(comment => {
				const isOwnComment = comment.is_own ||
				(
					currentUser.id === 0 &&
					guestData.email &&
					comment.email &&
					guestData.email === comment.email
				)

				console.log('üîπ –†–µ–Ω–¥–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞', 'id:' + comment.id, 'is_own:' + isOwnComment)

				const isDeleted = comment.is_deleted

				const el = createCommentElement({
					id: comment.id,
					author: comment.author,
					text: comment.text.replace(/<br\s*\/?>/gi, '\n'),
					avatar: comment.avatar,
					date: comment.date,
					likes: comment.likes,
					dislikes: comment.dislikes,
					can_delete: isOwnComment && !isDeleted,
					show_reply: !isOwnComment && !isDeleted
				})

				if (isDeleted) {
					console.log('üîπ –†–µ–Ω–¥–µ—Ä —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è id:', comment.id)

					el.classList.add('comment_deleted')

					el.querySelectorAll('.comment__like, .comment__dislike').forEach(b => {
						b.classList.add('disabled')
						b.addEventListener('click', e => {
							e.preventDefault()
							e.stopImmediatePropagation()
							console.log('üîπ –ö–ª–∏–∫ –ø–æ —Ä–µ–∞–∫—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—Ä–µ–Ω–¥–µ—Ä)')
						})
					})
				}


				if (!el) return 

				commentsMap.set(comment.id, {
					data: comment,
					el
				})
			})

			// 2Ô∏è‚É£ –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—è–º
			commentsMap.forEach(({ data, el }) => {
				if (data.parent && commentsMap.has(data.parent)) {
					const parentEl = commentsMap.get(data.parent).el
					parentEl.querySelector('.comment__content')?.appendChild(el)
				} else {
					wrapper.appendChild(el)
				}
			})

			initReply()
			updateCommentsUI()
		}

		
		// ===============================
		// –õ–∞–π–∫–∏ / –¥–∏–∑–ª–∞–π–∫–∏
		// ===============================
		const handleReaction = async (btn, type, action) => {

			console.log('üîπ window.commentsData', window.commentsData);

			if (!btn) return
			const container = btn.closest('.gray-text')
			if (!container) return

			const likeBtn = container.querySelector('.comment__like')
			const dislikeBtn = container.querySelector('.comment__dislike')
			const likeCountEl = likeBtn.querySelector('span')
			const dislikeCountEl = dislikeBtn.querySelector('span')

			const likeActive = likeBtn.classList.contains('active')
			const dislikeActive = dislikeBtn.classList.contains('active')

			btn.disabled = true

			try {
				const formData = new FormData()
				formData.append('action', `${action}_${type}`)
				formData.append('nonce', '<?=wp_create_nonce("like_nonce")?>')

				if (type==='comment') {
					formData.append('comment_id', btn.dataset.commentId)
				}

				const result = await fetch('<?=admin_url("admin-ajax.php")?>', { 
					method: 'POST', 
					body: formData 
				})

				const data = await result.json().catch(() => null)
				console.log('üîπ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞:', data)

				if (!data?.success) return

				// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –ø–æ –¥–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞
				if (data.data.likes !== undefined) likeCountEl.textContent = data.data.likes
				if (data.data.dislikes !== undefined) dislikeCountEl.textContent = data.data.dislikes

				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
				if (action === 'like') {
					if (data.data.active) {
						likeBtn.classList.add('active')
						dislikeBtn.classList.remove('active')
					} else {
						likeBtn.classList.remove('active')
					}
				} else {
					if (data.data.active) {
						dislikeBtn.classList.add('active')
						likeBtn.classList.remove('active')
					} else {
						dislikeBtn.classList.remove('active')
					}
				}

			} catch(e) { 
				console.log('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞', e) 
			} finally { 
				btn.disabled = false 
			}
		}

		document.addEventListener('click', e => {
			const btn = e.target.closest('.comment__like, .comment__dislike')
			if (!btn) return
			e.preventDefault()
			handleReaction(btn, 'comment', btn.classList.contains('comment__like') ? 'like' : 'dislike')
		})

		// ===============================
		// –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
		// ===============================
		const deleteComment = async btn => {
			const el = btn.closest('.comment')
			if (!el || el.classList.contains('is-deleting')) return

			btn.disabled = true
			el.classList.add('is-deleting')

			try {
				const formData = new FormData()
				formData.append('action', 'delete_comment')
				formData.append('comment_id', btn.dataset.commentId)
				formData.append('guest_email', guestData.email || '')
				formData.append('nonce', '<?=wp_create_nonce("delete_comment")?>')

				const res = await fetch('<?=admin_url("admin-ajax.php")?>', {
					method: 'POST',
					body: formData
				})

				const data = await res.json().catch(() => null)

				if (data?.success) {
					console.log('üîπ –£—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ, action:', data.data.action)

					el.querySelector('.comment__delete')?.remove()

					if (data.data.action === 'deleted') {
						console.log('üîπ –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–∑ DOM, id:', btn.dataset.commentId)

						el.classList.add('bounceOutLeft')

						notify('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω', '', 'info')

						setTimeout(() => {
							const parentComment = el.closest('.comment')?.parentElement?.closest('.comment')

							el.remove()
							updateCommentsUI()

							// üî• –í–û–¢ –°–Æ–î–ê
							if (parentComment && parentComment.classList.contains('comment_deleted')) {
								const replies = parentComment.querySelectorAll(':scope > .comment__content > .comment').length

								console.log(
									'üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ',
									'parentId:', parentComment.id,
									'repliesLeft:', replies
								)

								if (replies === 0) {
									console.log('üîπ –†–æ–¥–∏—Ç–µ–ª—å –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é')
									parentComment.classList.add('bounceOutLeft')

									setTimeout(() => {
										parentComment.remove()
										updateCommentsUI()
									}, 200);
								}
							}
 
						}, 600)
					}

					if (data.data.action === 'hidden') {
						console.log('üîπ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∫—Ä—ã—Ç (–µ—Å—Ç—å –æ—Ç–≤–µ—Ç—ã), id:', btn.dataset.commentId)

						const textEl = el.querySelector('.comment__text')
						const metaEl = el.querySelector('.comment__meta')

						if (textEl) {
							textEl.innerHTML = '<em class="gray-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω</em>'
							console.log('üîπ –¢–µ–∫—Å—Ç –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω"')
						}

						// —É–±–∏—Ä–∞–µ–º –ª–∞–π–∫–∏ / –¥–∏–∑–ª–∞–π–∫–∏
						metaEl?.querySelectorAll('.comment__like, .comment__dislike').forEach(b => {
							b.classList.add('disabled')
							b.addEventListener('click', e => {
								e.preventDefault()
								e.stopImmediatePropagation()
								console.log('üîπ –ö–ª–∏–∫ –ø–æ —Ä–µ–∞–∫—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—É–¥–∞–ª—ë–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)')
							})
						})

						// —É–±–∏—Ä–∞–µ–º "–û—Ç–≤–µ—Ç–∏—Ç—å"
						metaEl?.querySelector('[data-reply]')?.remove()
						console.log('üîπ –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" —É–¥–∞–ª–µ–Ω–∞')

						el.classList.add('comment_deleted')
						updateCommentsUI()
					}
				} else {
					notify('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', '', 'danger', false)
				}

			} catch (e) {
				console.error('üîπ –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', e)
				notify('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', '', 'danger', false)
			} finally {
				btn.disabled = false
				el.classList.remove('is-deleting')
			}
		}
		
		document.addEventListener('click', e => {
			const commentDeleteButton = e.target.closest('.comment__delete')

			if (commentDeleteButton) {
				deleteComment(commentDeleteButton)
			}
		})
	})
</script>
      
<!-- –û—Ç–∑—ã–≤—ã -->
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.querySelector('.popup-feedback form');
 
		form.addEventListener('submit', async e => {
			e.preventDefault();

			const formData = new FormData(form);

			const response = await fetch('/wp-admin/admin-ajax.php', {
				method: 'POST',
				body: new URLSearchParams({
					action: 'send_feedback',
					...Object.fromEntries(formData)
				})
			}); 

			const result = await response.json();
  
			if (result.success){
				successSubmitForm(form)
			}
		});  
	});

</script>

</body> 
</html>   
